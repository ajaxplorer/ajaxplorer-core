<?xml version="1.0" encoding="UTF-8"?>
<ajxp_plugin name="share" label="CONF_MESSAGE[Sharing Features]" description="CONF_MESSAGE[Share Center actions and hooks]"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="file:../core.ajaxplorer/ajxp_registry.xsd">
    <server_settings>
        <global_param name="DISABLE_ALL_SHARING" group="CONF_MESSAGE[Authorizations]" description="CONF_MESSAGE[Disable all sharing on files or folders]" label="CONF_MESSAGE[Disable all sharing]" type="boolean" default="false" expose="false"/>
        <global_param name="DISABLE_RESHARING" group="CONF_MESSAGE[Authorizations]" description="CONF_MESSAGE[Disallow all sharing for shared workspaces]" label="CONF_MESSAGE[Disable resharing]" type="boolean" default="true" expose="false"/>
        <global_param name="ENABLE_FILE_PUBLIC_LINK" group="CONF_MESSAGE[Authorizations]" description="CONF_MESSAGE[Allow users to generate public links on files]" label="CONF_MESSAGE[Files: enable public links]" type="boolean" default="true" expose="true"/>
        <global_param name="ENABLE_FILE_INTERNAL_SHARING" group="CONF_MESSAGE[Authorizations]" description="CONF_MESSAGE[Enable internal file sharing (sharing with users existing or temporary users)]" label="CONF_MESSAGE[Files: enable internal sharing]" type="boolean" mandatory="true" default="true" expose="true"/>
        <global_param name="ENABLE_FOLDER_PUBLIC_LINK" group="CONF_MESSAGE[Authorizations]" description="CONF_MESSAGE[Allow users to generate public links on folders]" label="CONF_MESSAGE[Folders: enable public links]" type="boolean" default="true" expose="true"/>
        <global_param name="ENABLE_FOLDER_INTERNAL_SHARING" group="CONF_MESSAGE[Authorizations]" description="CONF_MESSAGE[Enable internal folder sharing (sharing with users existing or temporary users)]" label="CONF_MESSAGE[Folders: enable internal sharing]" type="boolean" mandatory="true" default="true" expose="true"/>
        <global_param name="HASH_MIN_LENGTH" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Minimum length of the generated hash]" label="CONF_MESSAGE[Hash minimum length]" type="integer" default="6"/>
        <global_param name="HASH_USER_EDITABLE" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Allow users to manually choose a hash for the generated links]" label="CONF_MESSAGE[Hash user-editable]" type="boolean" default="true" expose="true"/>
        <global_param name="FILE_MAX_EXPIRATION" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Maximum share expiration limit for file, 0 = unlimited]" label="CONF_MESSAGE[Maximum file expiration limit]" type="integer" default="0" expose="true"/>
        <global_param name="FILE_MAX_DOWNLOAD" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Maximum download limit for file, 0 = unlimited]" label="CONF_MESSAGE[Maximum file download limit]" type="integer" default="0" expose="true"/>
        <global_param name="SHARE_FORCE_PASSWORD" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Do not allow users to create public links, only private links (password-protected)]" label="CONF_MESSAGE[Set password mandatory]" type="boolean" default="false" expose="true"/>
        <global_param name="EMAIL_INVITE_EXTERNAL" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Use external mailer for invitations]" label="CONF_MESSAGE[Force External Mailer]" type="boolean" default="false" expose="true"/>
        <global_param name="CREATE_QRCODE" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Create and display QRCode for shared link]" label="CONF_MESSAGE[Create QRCode]" type="boolean" default="false" expose="true"/>
        <global_param name="INFOPANEL_DISPLAY_HTML_EMBED" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Display pasteable HTML snippet in right-hand information panel]" label="CONF_MESSAGE[Display HTML Embed code]" type="boolean" default="false" expose="true"/>
        <global_param name="INFOPANEL_DISPLAY_DIRECT_DOWNLOAD" group="CONF_MESSAGE[Link Generation]" description="CONF_MESSAGE[Display pasteable download link in right-hand information panel]" label="CONF_MESSAGE[Display Direct Download Link]" type="boolean" default="false" expose="true"/>
        <global_param name="AVOID_SHARED_FOLDER_SAME_LABEL" group="CONF_MESSAGE[Internal Sharing]" description="CONF_MESSAGE[Disallow users to create shared folders if a workspace already exists with the same label]" label="CONF_MESSAGE[Avoid labels duplication]" type="boolean" default="false"/>
        <global_param name="SHARED_USERS_TMP_PREFIX" group="CONF_MESSAGE[Internal Sharing]" description="CONF_MESSAGE[Mandatory prefix for users created temporary users login]" label="CONF_MESSAGE[Tmp users prefix]" type="string" expose="true"/>
        <global_param name="FORK_EVENT_FORWARDING" group="CONF_MESSAGE[Internal Sharing]" type="boolean" label="CONF_MESSAGE[Fork Events Forwarding]" description="CONF_MESSAGE[If you detect performances issues while modifiyng files under deep trees, try activating that one. Please be sure of what you do, this may trigger a whole lot of php processes on the server.]" default="false"/>
        <global_param name="WATCHER_SHARES_AUTO_OWNER" group="CONF_MESSAGE[Notifications]" type="boolean" label="CONF_MESSAGE[Shares Owner]" description="CONF_MESSAGE[When sharing with some internal users, choose whether the owner will be notified by default of any event happening on this share]" default="false" expose="true"/>
        <global_param name="WATCHER_SHARES_AUTO_USERS" group="CONF_MESSAGE[Notifications]" type="boolean" label="CONF_MESSAGE[Shares Target users]" description="CONF_MESSAGE[When sharing with some internal users, choose whether these users will be notified by default of any event happening on this share]" default="false" expose="true"/>
    </server_settings>
    <client_settings>
        <resources>
            <i18n namespace="share_center" path="plugins/action.share/res/i18n"/>
            <css file="plugins/action.share/res/react-share-form.css" autoload="true"/>
            <js file="plugins/action.share/res/build/model/ShareModel.js" className="ReactModelShare"/>
            <js file="plugins/action.share/res/build/ShareTemplates.js" className="ShareTemplates" depends="React"/>
            <js file="plugins/action.share/res/build/ShareInfoPanel.js" className="ShareInfoPanel" depends="React,ReactModelShare"/>
            <js file="plugins/action.share/res/build/ShareDialog.js" className="ShareDialog" depends="React,ReactModelShare,PydioForm,UsersCompleter"/>
        </resources>
    </client_settings>
    <registry_contributions>
        <actions>
            <action name="share_react">
                <gui text="292" title="292" src="share.png" iconClass="mdi mdi-share-variant" hasAccessKey="false">
                    <context selection="true" dir="true" recycle="hidden" actionBar="true" actionBarGroup="get,info_panel_share" contextMenu="true"/>
                    <selectionContext dir="true" file="true" recycle="false" unique="true" evalMetadata="!metadata.get('ajxp_shared')"/>
                </gui>
                <rightsContext noUser="true" userLogged="only" read="true" write="false" adminOnly=""/>
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
                        if(!pydio.getController().shareDialogLoader) {
                            pydio.getController().shareDialogLoader = new AjxpReactDialogLoader('ShareDialog', 'MainPanel', {
                                selection:pydio.getUserSelection()
                            });
                        }
                        pydio.getController().shareDialogLoader.openDialog('react_share_form', true);
                    ]]></clientCallback>
                    <clientForm id="react_share_form"><![CDATA[
                        <div id="react_share_form" box_padding="0" class="react-mui-context SF_material"></div>
                    ]]></clientForm>
                </processing>
            </action>
            <action name="share-edit-shared">
                <gui src="share.png" iconClass="mdi mdi-share-variant" text="share_center.125" title="share_center.126">
                    <context dir="true" recycle="hidden" selection="true" actionBar="true" contextMenu="true" actionBarGroup="get,info_panel_share" behaviour="hidden"/>
                    <selectionContext dir="true" file="true" evalMetadata="metadata.get('ajxp_shared')" recycle="false" unique="true" behaviour="hidden"/>
                </gui>
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
                        if(!pydio.getController().shareDialogLoader) {
                            pydio.getController().shareDialogLoader = new AjxpReactDialogLoader('ShareDialog', 'MainPanel', {
                                selection:pydio.getUserSelection()
                            });
                        }
                        pydio.getController().shareDialogLoader.openDialog('react_share_form', true);
                    ]]></clientCallback>
                </processing>
            </action>
            <action name="share">
                <rightsContext noUser="true" userLogged="only" read="true" write="false" adminOnly=""/>
                <processing>
                    <serverCallback methodName="switchAction" restParams="/simple_share_type/file+" developerComment="Main action for sharing a file or a folder">
                        <input_param description="Path of the resource to share" name="nodes" type="AJXP_NODE[]" mandatory="true"/>
                        <input_param description="Simple type for sharing via the REST api, always links, public or private" name="simple_share_type" type="public|private" mandatory="false"/>
                        <input_param description="Specific type of sharing" name="sub_action" type="delegate_repo|create_minisite|public_link" mandatory="true"/>
                        <input_param description="For editing the data of an existing workspace/minisite" name="repository_id" type="string" mandatory="false"/>
                        <input_param description="For a workspace, directly set a watch on this for the current user" name="self_watch_folder" type="boolean"/>
                        <input_param description="For a minisite, will determine whether it will be public (true) or private (false), creating a temporary user in the first case." name="create_guest_user" type="boolean"/>
                        <input_param description="For a workspace/private minisite, define zero or more ACL for users" name="user_[n]" type="string"/>
                        <input_param description="For a workspace/private minisite, read right for user N" name="right_read_[n]" type="boolean"/>
                        <input_param description="For a workspace/private minisite, write right for user N" name="right_write_[n]" type="boolean"/>
                        <input_param description="For a workspace/private minisite, watch status for user N" name="right_watch_[n]" type="boolean"/>
                        <input_param description="For a public link, set a maximum number of downloads authorized" name="downloadlimit" type="integer"/>
                        <input_param description="For a public link, set a maximum number of authorized days" name="expiration" type="integer"/>
                        <input_param description="For a public link, set a password" name="password" type="string"/>
                        <input_param description="For a minisite on file or folder, force a custom link handle" name="custom_handle" type="string"/>
                        <input_param description="Additional plugins data that can be stored in the shared resource" name="PLUGINS_DATA" type="FORM_DATA"/>
                    </serverCallback>
                    </processing>
            </action>
            <action name="migrate_legacy_shares">
                <rightsContext adminOnly="true" noUser="false" read="true" userLogged="true" write="true"/>
                <processing>
                    <serverCallback methodName="migrateLegacyShares" restParams="/dry_run"/>
                </processing>
            </action>
            <action name="load_shared_element_data">
                <processing>
                    <serverCallback methodName="switchAction" restParams="/file+" developerComment="Loads all current sharing data for a given resource. Workspace must support metadata management (metastore).">
                        <input_param description="Path of the resource to share" name="file" type="path" mandatory="true"/>
                        <input_param description="Type of element to load (file or folder)" name="element_type" type="file|repository" mandatory="true"/>
                        <output type="application/json"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="unshare">
                <processing>
                    <serverCallback methodName="switchAction" restParams="/file+" developerComment="Stop sharing a folder, or remove a public link from a file.">
                        <input_param description="Path of the resource to unshare" name="file" type="path" mandatory="true"/>
                        <input_param description="Type of element to load (file or folder)" name="element_type" type="file|repository" mandatory="true"/>
                        <input_param description="If the resource is a file, send also the element_id, as many links can be generated for one file" name="element_id" type="string"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="toggle_link_watch">
                <processing>
                    <serverCallback methodName="switchAction" restParams="/file+" developerComment="Toggle a shared element status for being watched or not.">
                        <input_param description="Path of the resource to unshare" name="file" type="path" mandatory="true"/>
                        <input_param description="Type of element to load (file or folder)" name="element_type" type="file|repository" mandatory="true"/>
                        <input_param description="If the resource is a file, send also the element_id, as many links can be generated for one file" name="element_id" type="string"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="reset_counter">
                <processing>
                    <serverCallback methodName="switchAction" restParams="/file+" developerComment="Reset download counter for a given link generated on a file.">
                        <input_param description="Path of the resource to unshare" name="file" type="path" mandatory="true"/>
                        <input_param description="Send also the element_id, as many links can be generated for one file" name="element_id" type="string"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="update_shared_element_data">
                <processing>
                    <serverCallback methodName="switchAction">
                        <input_param description="Path of the resource to unshare" name="file" type="path" mandatory="true"/>
                        <input_param description="Send also the element_id, as many links can be generated for one file" name="element_id" type="string"/>
                        <input_param description="Name of the property to modify (only tags supported)" name="p_name" type="string" mandatory="true" default="tags"/>
                        <input_param description="Value of the property to modify" name="p_value" type="string" mandatory="true"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="forward_change_event">
                <processing>
                    <serverCallback methodName="forwardEventToSharesAction"/>
                </processing>
            </action>
            <action name="sharelist-edit">
                <gui src="share.png" iconClass="mdi mdi-share-variant" text="share_center.125" title="share_center.126">
                    <context dir="true" recycle="false" selection="true" actionBar="true" actionBarGroup="share_list_toolbar-selection" behaviour="hidden"/>
                    <selectionContext dir="true" file="true" evalMetadata="metadata.get('ajxp_shared')" recycle="false" unique="true" behaviour="hidden"/>
                </gui>
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
                        var dataModel;
                        if(window.actionArguments && window.actionArguments.length){
                            dataModel = window.actionArguments[0];
                        }else if(window.actionManager){
                            dataModel = window.actionManager.getDataModel();
                        }
                        var dialog = new AjxpReactDialogLoader('ShareDialog', 'MainPanel', {selection:dataModel, readonly:true});
                        dialog.openDialog('react_share_form', true);
                    ]]></clientCallback>
                    <clientForm id="react_share_form"><![CDATA[
                        <div id="react_share_form" box_padding="0" class="react-mui-context SF_material"></div>
                    ]]></clientForm>
                </processing>
            </action>
            <action name="sharelist-load">
                <gui src="share.png" iconClass="icon-refresh" text="149" title="149">
                    <context dir="true" recycle="false" selection="false" actionBar="true" actionBarGroup="share_list_toolbar" behaviour="hidden"/>
                </gui>
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
                        if(window.actionManager){
                            window.actionManager.getDataModel().requireContextChange(window.actionManager.getDataModel().getRootNode(), true);
                        }
                    ]]></clientCallback>
                </processing>
                <processing>
                    <serverCallback restParams="/" methodName="switchAction" sdkMethodName="loadShareList">
                        <input_param description="Parent repository ID" name="parent_repository_id" type="string" mandatory="false"/>
                        <input_param name="user_context" type="string" description="Either global (all users, requires admin right) or current (current user)" default="current"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="sharelist-clearExpired">
                <gui text="user_dash.25" title="user_dash.26" iconClass="icon-time" src="edit_clear_history.png" accessKey="" hasAccessKey="false">
                    <context dir="true" selection="false" recycle="false" 
                             actionBar="true" contextMenu="false" infoPanel="false"
                             actionBarGroup="share_list_toolbar" inZip="false"/>
                </gui>
                <rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly=""/>
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
						var conn = new Connexion();
						conn.addParameter("get_action", "sharelist-clearExpired");
						var dm = window.actionManager.getDataModel();
						conn.onComplete = function(transport){
							PydioApi.getClient().parseXmlMessage(transport.responseXML);
                            if(window.actionManager){
                                dm.requireContextChange(dm.getRootNode(), true);
                            }
						};
						conn.sendAsync();
					]]></clientCallback>
                    <serverCallback methodName="switchAction" developerComment="Clear expired links" restParams="/"/>
                </processing>
            </action>
            <action name="share_current_page">
                <gui src="" iconClass="mdi mdi-share-variant" text="share_center.110" title="share_center.110">
                    <context dir="true" recycle="false" selection="false" actionBarGroup="minisite-share-actions" actionBar="true"/>
                </gui>
                <processing>
                    <clientCallback dialogOpenForm="share_current_url" dialogSkipButtons="true" prepareModal="true">
                        <dialogOnOpen><![CDATA[
                            modal.getForm().down("#crt-page-url").setValue(document.location.href);
                            if(ajxpBootstrap.parameters.get('PRESET_LOGIN') === 'ajxp_preloged_user' && !ajaxplorer.getContextHolder().isEmpty() && pydio.getController().getActionByName("download")){
                                var tpl = new Template('<div style="font-size: 16px; padding-top:15px; text-align:left;">#{title} <a href="#{link}" target="_blank" class="icon-link" style="font-size: 0.8em;"></a></div><input type="text" value="#{link}" style="width: 98%;">');
                                var node = ajaxplorer.getContextHolder().getUniqueNode();
                                var editors = pydio.Registry.findEditorsForMime(node.getAjxpMime(), true);
                                if(editors.length && Class.getByName(editors[0].editorClass)){
                                    var staticClass = Class.getByName(editors[0].editorClass).prototype;
                                    if(staticClass.getRESTPreviewLinks){
                                        var links = staticClass.getRESTPreviewLinks(node);
                                        $H(links).each(function(pair){
                                            modal.getForm().down("#additional_links").insert(tpl.evaluate({title:pair.key,link:document.location.href.split('?').shift() + "/dl"+node.getPath()+"?ct=true"+pair.value}));
                                        });
                                    }
                                }
                                var dlLink = document.location.href.split('?').shift() + "/dl" + node.getPath();
                                modal.getForm().down("#additional_links").insert(tpl.evaluate({title:MessageHash['share_center.60'],link:dlLink}));
                            }
                        ]]></dialogOnOpen>
                        <dialogOnComplete><![CDATA[
                            hideLightBox();
                        ]]></dialogOnComplete>
                        <dialogOnCancel><![CDATA[]]></dialogOnCancel>
                    </clientCallback>
                    <clientForm id="share_current_url"><![CDATA[
                        <div id="share_current_url" box_width="300" style="text-align:center;">
                            <input type="text" id="crt-page-url" onclick="$(this).select();" value="" style="width: 387px;text-align: center;font-size: 19px;margin: 10px 0;padding: 5px;">
                            <div class="non_macos">AJXP_MESSAGE[share_center.143]</div>
                            <div class="macos_only" style="display:none;">AJXP_MESSAGE[share_center.144]</div>
                            <br>
                            <div id="additional_links" style="padding-bottom:10px;"></div>
                        </div>
                    ]]></clientForm>
                </processing>
            </action>
            <action name="download">
                <pre_processing>
                    <serverCallback methodName="preProcessDownload" applyCondition="$apply=\Pydio\Core\Services\SessionService::has(\Pydio\Core\Services\SessionService::CTX_MINISITE_HASH);"/>
                </pre_processing>
            </action>
        </actions>
        <client_configs>
            <template name="minisite_orbit" element="ajxp_shared_folder" position="top" label="share_center.153"><![CDATA[
				<div id="browser" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height"}'>
                    <div id="logo_widget" class="widget_logo" ajxpClass="LogoWidget"  ajxpOptions='{"imageParameter":"gui.ajax/CUSTOM_MINISITE_LOGO"}'></div>
                    <div id="widget_title" ajxpClass="RepositorySimpleLabel" ajxpOptions='{"displayLabelLegend":false,"displayWorkspaceDescription":true}'></div>
                    <div id="breadcrumb" ajxpClass="Breadcrumb" ajxpOptions='{}'></div>
                    <div id="files_list_header">
                        <div id="display_toolbar" ajxpClass="ActionsToolbar" ajxpOptions='{"submenuClassName":"panelHeaderMenu","submenuPosition":"bottom right","submenuOffsetTop":12,"toolbarsList":["content_pane-actions"],"submenuOffsetTop":2}'></div>
                        <div id="buttons_bar" class="action_bar" ajxpClass="ActionsToolbar" ajxpOptions='{"toolbarsList":["navigation","minisite", "inline"],"submenuOffsetTop":2}'></div>
                    </div>
                    <div id="cpane_container1" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height","fitParent":"browser"}'>
                        <div id="content_pane" ajxpClass="FilesList" ajxpOptions='{"displayMode":"detail", "detailThumbSize": 50 ,"replaceScroller":true, "messageBoxReference":true, "fit":"height", "fitParent":"cpane_container1", "cellPaddingCorrection":6, "iconBgPosition" : "5px 4px", "invisibleSelection":false}' style="border: 1px solid #bbb; border-width:0 1px;"></div>
                    </div>
                    <div id="tasks_panel" class="react-mui-context" ajxpClass="AjxpReactComponent" ajxpOptions='{"componentNamespace":"PydioTasks","componentName":"Panel"}'></div>
				</div>
                <script>
                document.observe("ajaxplorer:afterApply-login", function(){
                    AjxpPane.prototype.staticApplyBackgroundFromConfigs($("overlay"), "gui.ajax/CUSTOM_SHAREPAGE_BACKGROUND_", "display:block;", true);
                });
                </script>
			]]></template>
            <template name="minisite_film_strip" element="ajxp_film_strip" position="top" label="share_center.154"><![CDATA[
				<div id="browser" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height"}'>
                    <div id="logo_widget" class="widget_logo" ajxpClass="LogoWidget" ajxpOptions='{"imageParameter":"gui.ajax/CUSTOM_MINISITE_LOGO"}'></div>
                    <div id="widget_title" ajxpClass="RepositorySimpleLabel" ajxpOptions='{"displayLabelLegend":false,"displayWorkspaceDescription":true}'></div>
                    <div id="cpane_container" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height","fitParent":"browser", "fitMarginBottom":80}'>
                        <div id="cpane_header" class="panelHeader">
                            <div id="display_toolbar" ajxpClass="ActionsToolbar" ajxpOptions='{"submenuClassName":"panelHeaderMenu","submenuPosition":"bottom right","submenuOffsetTop":12,"toolbarsList":["minisite", "inline"],"submenuOffsetTop":2}'></div>
                            <div id="breadcrumb" ajxpClass="Breadcrumb" style="width:50%;" ajxpOptions='{"flexTo":"cpane_header", "flexToMargin":50, "resize_events":["actions_refreshed"]}'></div>
                        </div>
                        <div id="cpane_tabs" ajxpClass="AjxpTabulator" ajxpOptions='{"fit":"height", "fitParent":"cpane_container","registerAsEditorOpener":true, "saveState":false, "defaultTabId": "","tabInfos" : [], "uniqueTab":true}'></div>
                        <div id="content_pane" ajxpClass="FilesList" ajxpOptions='{"displayMode":"thumb", "fixedDisplayMode":"thumb", "fixedThumbSize":60,"replaceScroller":false, "horizontalScroll":true, "messageBoxReference":true, "fit":"content", "fitParent":"cpane_container", "cellPaddingCorrection":6, "iconBgPosition" : "5px 4px", "invisibleSelection":false}'></div>
                    </div>
				</div>
				<script>
                    document.observe("ajaxplorer:afterApply-login", function(){
                        AjxpPane.prototype.staticApplyBackgroundFromConfigs($("overlay"), "gui.ajax/CUSTOM_SHAREPAGE_BACKGROUND_", "display:block;", true);
                    });
                    document.observe("ajaxplorer:selection_changed", function(e){
                        try{
                            var dm = ajaxplorer.getContextHolder();
                            var nodes = dm.getSelectedNodes();
                            if(nodes[0].isLeaf() && e.memo._selectionSource.__className == 'FilesList'){
                                window.setTimeout(function(){pydio.getController().fireDefaultAction("file");}, 1);
                            }
                        }catch(e){}
                    });
                    var p;
				    document.observe("ajaxplorer:user_logged", function(){
                        if(p) return;
                        try{
                            p = new PeriodicalExecuter(function(){
                                var dm = ajaxplorer.getContextHolder();
                                if(dm.getSelectedNodes().length){
                                    p.stop();
                                    return;
                                }
                                var first = dm.getRootNode().getFirstChildIfExists();
                                if(first){
                                    dm.setSelectedNodes([first], "dataModel");
                                    window.setTimeout(function(){pydio.getController().fireDefaultAction("file");}, 1);
                                    p.stop();
                                    return;
                                }
                            }, 1);
                        }catch(e){}
                    });
				</script>
			]]></template>
            <template name="unique_preview_file" element="ajxp_unique_strip" position="top" label="Unique File Preview"><![CDATA[
				<div id="browser" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height"}'>
                    <div id="logo_widget" class="widget_logo" ajxpClass="LogoWidget" ajxpOptions='{"imageParameter":"gui.ajax/CUSTOM_MINISITE_LOGO"}'></div>
                    <div id="display_toolbar" ajxpClass="ActionsToolbar" ajxpOptions='{"submenuClassName":"panelHeaderMenu","submenuPosition":"bottom right","submenuOffsetTop":12,"toolbarsList":["inline", "minisite-share-actions"],"submenuOffsetTop":2}'></div>
                    <div id="widget_title" style="padding: 28px 0 22px 20px;" ajxpClass="RepositorySimpleLabel" ajxpOptions='{"displayLabelLegend":false,"displayWorkspaceDescription":true}'></div>
                    <div id="cpane_container" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height","fitParent":"browser"}'>
                        <div id="cpane_tabs" ajxpClass="AjxpTabulator" ajxpOptions='{"fit":"height", "fitParent":"cpane_container","registerAsEditorOpener":true, "saveState":false, "defaultTabId": "","tabInfos" : [], "uniqueTab":true}'></div>
                    </div>
				</div>
				<script>
                    document.observe("ajaxplorer:afterApply-login", function(){
                        AjxpPane.prototype.staticApplyBackgroundFromConfigs($("overlay"), "gui.ajax/CUSTOM_SHAREPAGE_BACKGROUND_", "display:block;", true);
                    });
				    document.observe("ajaxplorer:user_logged", function(){
                        try{

                            var p = new PeriodicalExecuter(function(){
                                var dm = ajaxplorer.getContextHolder();
                                if(dm.getSelectedNodes().length){
                                    p.stop();
                                    return;
                                }
                                var root = dm.getRootNode();
                                var first = root.getFirstChildIfExists();
                                if(first){
                                    if((first.getAjxpMime() == 'mp3' || first.getAjxpMime() == 'wav') && !(window.soundManager && window.soundManager.enabled)){
                                        return;
                                    }
                                    dm.setSelectedNodes([first], "dataModel");
                                    window.setTimeout(function(){pydio.getController().fireDefaultAction("file");}, 1);
                                    p.stop();
                                    return;
                                }
                            }, 1);
                        }catch(e){
                            if (console) console.log(e);
                        }
                    });
				</script>
			]]></template>
            <template name="unique_preview_download" element="ajxp_unique_dl" position="top" label="Big download button"><![CDATA[
				<div id="browser" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height"}'>
                    <div id="background_container" ajxpClass="AjxpPane" ajxpOptions='{"imageBackgroundFromConfigs":"gui.ajax/CUSTOM_SHAREPAGE_BACKGROUND_"}'></div>
                    <div id="cpane_container" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height","fitParent":"browser"}'>
                        <div id="logo_widget" class="widget_logo" ajxpClass="LogoWidget"  ajxpOptions='{"imageParameter":"gui.ajax/CUSTOM_MINISITE_LOGO"}'></div>
                    </div>
                    <div class="vertical-align">
                        <div class="vertical-align-center">
                            <div id="reactDLTemplate" ajxpClass="AjxpReactComponent" ajxpOptions='{"componentNamespace":"ShareTemplates","componentName":"DLTemplate"}'></div>
                            <div id="share_toolbar" ajxpClass="ActionsToolbar" ajxpOptions='{"toolbarsList":["minisite-share-actions"]}'></div>
                        </div>
                    </div>
                </div>
			]]></template>
            <template name="minisite_bare" element="ajxp_embed_template" position="top" label="share_center.155"><![CDATA[
				<div id="browser" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height"}'>
                    <div id="cpane_header" class="panelHeader">
                        <div id="display_toolbar" ajxpClass="ActionsToolbar" ajxpOptions='{"submenuClassName":"panelHeaderMenu","submenuPosition":"bottom right","submenuOffsetTop":12,"toolbarsList":["navigation", "minisite", "inline", "content_pane-actions"],"submenuOffsetTop":2}'></div>
                        <div id="breadcrumb" ajxpClass="Breadcrumb" style="width:50%;" ajxpOptions='{"flexTo":"cpane_header", "flexToMargin":30}'></div>
                    </div>
                    <div id="content_pane" ajxpClass="FilesList" ajxpOptions='{"displayMode":"detail", "detailThumbSize": 50 ,"replaceScroller":true, "messageBoxReference":true, "fit":"height", "fitParent":"cpane_container", "cellPaddingCorrection":6, "iconBgPosition" : "5px 4px", "invisibleSelection":false}' style="border: 1px solid #bbb; border-width:0 1px;"></div>
                    <div id="logo_widget" class="widget_logo" ajxpClass="LogoWidget"  ajxpOptions='{"imageParameter":"gui.ajax/CUSTOM_MINISITE_LOGO"}'></div>
                    <div id="tasks_panel" class="react-mui-context" ajxpClass="AjxpReactComponent" ajxpOptions='{"componentNamespace":"PydioTasks","componentName":"Panel"}'></div>
				</div>
                <script>
                    document.observe("ajaxplorer:afterApply-login", function(){
                        AjxpPane.prototype.staticApplyBackgroundFromConfigs($("overlay"), "gui.ajax/CUSTOM_SHAREPAGE_BACKGROUND_", "display:block;", true);
                    });
                </script>
			]]></template>
            <template name="minisite_dropbox" element="ajxp_dropbox_template" position="top" label="share_center.163"><![CDATA[
				<div id="browser" ajxpClass="AjxpPane" ajxpOptions='{"fit":"height"}'>
                    <div id="cpane_header" class="panelHeader">
                        <div id="display_toolbar" ajxpClass="ActionsToolbar" ajxpOptions='{"submenuClassName":"panelHeaderMenu","submenuPosition":"bottom right","submenuOffsetTop":12,"toolbarsList":["minisite", "inline","content_pane-actions"],"submenuOffsetTop":2}'></div>
                        <div id="breadcrumb" ajxpClass="Breadcrumb" style="width:50%;" ajxpOptions='{"flexTo":"cpane_header", "flexToMargin":30}'></div>
                    </div>
                    <div id="content_pane" ajxpClass="FilesList" ajxpOptions='{"displayMode":"detail", "detailThumbSize": 50 ,"replaceScroller":true, "messageBoxReference":true, "fit":"height", "fitParent":"cpane_container", "cellPaddingCorrection":6, "iconBgPosition" : "5px 4px", "invisibleSelection":false}' style="border: 1px solid #bbb; border-width:0 1px;"></div>
                    <div id="logo_widget" class="widget_logo" ajxpClass="LogoWidget" ajxpOptions='{"imageParameter":"gui.ajax/CUSTOM_MINISITE_LOGO"}'></div>
                    <div id="tasks_panel" class="react-mui-context" ajxpClass="AjxpReactComponent" ajxpOptions='{"componentNamespace":"PydioTasks","componentName":"Panel"}'></div>
				</div>
				<script>
                    document.observe("ajaxplorer:afterApply-login", function(){
                        AjxpPane.prototype.staticApplyBackgroundFromConfigs($("overlay"), "gui.ajax/CUSTOM_SHAREPAGE_BACKGROUND_", "display:block;", true);
                    });
                </script>
			]]></template>
            <component_config className="InfoPanel">
                <infoPanelExtension mime="meta:ajxp_shared" attributes="" modifier="ShareInfoPanel.loader">
                    <messages>
                        <message key="type_string" id="share_center.50"/>
                    </messages>
                    <html><![CDATA[
                        <div id="ajxp_shared_info_panel" data-infoPanelPosition="first">
                            <div class="panelHeader infoPanelGroup" colspan="2">
                                <span class="user_meta_change" style="display: none;" data-ajxpaction="share-edit-shared" >AJXP_MESSAGE[457]</span>
                                <span class="mdi mdi-share-variant" data-ajxpAction="share-edit-shared" title="AJXP_MESSAGE[share_center.55]"></span>#{type_string}
                                </div>
                            <div class="infoPanelTable" cellspacing="0" border="0" cellpadding="0"></div>
                        </div>
                    ]]></html>
                </infoPanelExtension>
            </component_config>
            <component_config className="AjxpTabulator::userdashboard_main_tab">
                <additional_tab id="shared_pane2"
                                tabInfo='{"id":"shares","iconClass":"mdi mdi-share-variant","element":"shared_pane2","closeable":false,"label":"share_center.98","title":"share_center.99","dontFocus":true,"position":4}'
                                paneInfo='{"type":"widget"}'><![CDATA[
                    <div id="shared_pane2" ajxpClass="AjxpPane" class="tabbed_editor">
                        <div class="title-flex">
                            <h3 class="dashboard_panel_title">AJXP_MESSAGE[share_center.98]<div class="legend">AJXP_MESSAGE[share_center.99]</div></h3>
                            <div id="buttons_bar" class="action_bar" ajxpClass="ActionsToolbar" ajxpOptions='{"dataModelElementId":"shared_files_list","toolbarsList":["share_list_toolbar-selection", "share_list_toolbar"],"submenuOffsetTop":2}'></div>
                        </div>
                        <div id="shared_files_list" ajxpClass="FetchedResultPane" ajxpOptions='{"displayMode":"list", "fixedDisplayMode":"list", "groupByData":"1", "fit":"height","selectionChangeCallback":false,"updateGlobalContext":false,"nodeProviderProperties":{"get_action":"sharelist-load","user_context":"current"}}'></div>
                    </div>
                ]]></additional_tab>
            </component_config>
        </client_configs>
        <hooks>
            <serverCallback hookName="node.info.nocache" methodName="nodeSharedMetadata"/>
            <serverCallback hookName="node.change" methodName="updateNodeSharedData"/>
            <serverCallback hookName="user.after_delete" methodName="cleanUserShares" defer="true"/>
            <serverCallback hookName="workspace.after_delete" methodName="cleanWorkspaceShares" defer="true"/>
            <serverCallback methodName="forwardEventToShares" hookName="node.change" defer="true"/>
        </hooks>
    </registry_contributions>
    <class_definition filename="plugins/action.share/src/ShareCenter.php" classname="Pydio\Share\ShareCenter"/>
    <dependencies>
        <!--<activePlugin pluginName="access.AJXP_STREAM_PROVIDER|access.ajxp_user|access.ajxp_conf|access.ajxp_admin"/>-->
    </dependencies>
</ajxp_plugin>
